# WLF Payload CMS - Incident Report & Post-Mortem

> **Date:** 2026-01-29  
> **Status:** ‚úÖ RESOLVED  
> **Duration:** ~2 hours (20:06 - 21:45 UTC)  
> **Checkpoint Tag:** `v1.4.0-whitescreenfix`

---

## Executive Summary

The PayloadCMS admin panel at `https://cms.wlf.com.mx/admin` showed a white screen due to missing JavaScript chunks. After investigation, two root causes were identified and fixed:

1. **Missing ImportMap** - The `@payloadcms/storage-s3` client component wasn't registered
2. **Stale Docker artifacts** - No `.dockerignore` caused old `.next` files to leak into builds

---

## üü¢ Final Status

| Component | Status | Details |
|-----------|--------|---------|
| **CMS URL** | ‚úÖ Working | `https://cms.wlf.com.mx/admin` login form visible |
| **Dokploy VPS** | ‚úÖ Running | `143.198.49.232` (dokploy-factory-v1) |
| **Payload Service** | ‚úÖ Running | 1/1 replicas, clean logs |
| **MongoDB** | ‚úÖ Healthy | `mongo-wjsixq` running |
| **Cloudflare** | ‚úÖ Correct | DNS correctly pointing to new VPS |

---

## üîç Root Cause Analysis

### Primary Cause: Missing ImportMap Entry

The admin panel showed a white screen because React hydration failed. The logs showed:

```
getFromImportMap: PayloadComponent not found in importMap {
  key: '@payloadcms/storage-s3/client#S3ClientUploadHandler',
  ...
}
```

**Why it happened:** The `@payloadcms/storage-s3` plugin registers client-side components that need to be in the importMap. The `pnpm payload generate:importmap` command was never run during Docker build.

### Secondary Cause: Stale Docker Build Artifacts

The 404 errors on JS chunks (`layout-dea88f249a52b16a.js`, `8881-4c1412da969be017.js`) were caused by:

1. No `.dockerignore` file existed
2. Local `.next/` folder was copied into Docker build context
3. Chunk hash mismatches between HTML and actual files

---

## üõ†Ô∏è Fixes Applied

### 1. Added `generate:importmap` to Build Script

**File:** `package.json`

```json
"build": "pnpm generate:importmap && cross-env NODE_OPTIONS=--no-deprecation next build ...",
"generate:importmap": "cross-env NODE_OPTIONS=--no-deprecation payload generate:importmap",
```

### 2. Created `.dockerignore`

**File:** `.dockerignore`

```
# Prevent local build artifacts from leaking into Docker
.next
node_modules
.git
apps/
docs/
```

### 3. Manual VPS Code Update

Dokploy wasn't pulling the latest commit. Fixed by:

```bash
ssh root@143.198.49.232 "cd /etc/dokploy/applications/payload-cms-uk3xw9/code && \
  git fetch origin && git reset --hard origin/main"
```

---

## üìä Timeline

| Time (UTC) | Event |
|------------|-------|
| 20:06 | Issue reported - admin showing white screen |
| 20:08 | Initial investigation - confirmed 502 then white screen |
| 20:15 | Identified chunk mismatch (layout-dea88f249a52b16a.js ‚Üí layout-88e07923fde944a8.js) |
| 20:18 | Found `getFromImportMap` errors in logs |
| 20:25 | Created `.dockerignore` and updated `package.json` |
| 20:30 | First rebuild - Dokploy used old cached commit |
| 20:35 | Manually updated code on VPS |
| 20:40 | Rebuilt Docker image with correct code |
| 20:41 | Admin panel working - login form visible |
| 21:45 | Created checkpoint tag `v1.4.0-whitescreenfix` |

---

## üö´ Prevention Measures

To prevent this from happening again:

### 1. Always Include `.dockerignore`
Every PayloadCMS project MUST have:
```
.next
node_modules
.git
```

### 2. Always Run ImportMap Generation
The build script MUST start with:
```
pnpm generate:importmap && ...
```

### 3. Verify Dokploy Pulls Latest Code
After pushing to GitHub, verify on VPS:
```bash
ssh root@143.198.49.232 "cd /etc/dokploy/applications/*/code && git log --oneline -1"
```

### 4. Created Deployment Workflow
See `.agent/workflows/deploy.md` for verified deployment steps.

---

## üè∑Ô∏è Checkpoint Created

**Tag:** `v1.4.0-whitescreenfix`

To restore this known-good version:
```bash
git checkout v1.4.0-whitescreenfix
```

All tags:
| Tag | Description | Status |
|-----|-------------|--------|
| `v1.4.0-whitescreenfix` | This fix - ImportMap + .dockerignore | ‚úÖ STABLE |
| `v1.3.0-full-template` | Full frontend (has white screen bug) | ‚ö†Ô∏è DEPRECATED |
| `v1.2.0-splithead-working` | Minimal proof of architecture | ‚ö†Ô∏è MINIMAL |
| `v1.1.0-monorepo-created` | Monorepo structure created | ‚ö†Ô∏è INCOMPLETE |
| `v1.0.0-before-splithead` | R2 integration, pre-split | ‚ö†Ô∏è OLD |

---

## üìù Lessons Learned

1. **Dokploy caches aggressively** - Always verify the cloned commit matches your pushed commit
2. **PayloadCMS plugins need importMap** - Any plugin with client components requires `generate:importmap`
3. **Docker context matters** - Without `.dockerignore`, local build artifacts can contaminate production
4. **White screen ‚â† no response** - The server was responding, but React wasn't hydrating

---

## üîó Related Documentation

- `docs/GIT_HISTORY.md` - Complete project evolution
- `docs/ARCHITECTURE.md` - Split-Head architecture
- `.agent/workflows/deploy.md` - Verified deployment workflow
